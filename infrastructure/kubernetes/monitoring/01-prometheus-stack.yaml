# 1. Prometheus Stack
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: prometheus-stack
  namespace: monitoring
spec:
  chart: kube-prometheus-stack
  repo: https://prometheus-community.github.io/helm-charts
  targetNamespace: monitoring
  valuesContent: |-
    prometheus:
      prometheusSpec:
        resources:
          requests:
            memory: 4Gi
            cpu: 1
          limits:
            memory: 8Gi
            cpu: 2
        storageSpec:
          volumeClaimTemplate:
            spec:
              accessModes: ["ReadWriteOnce"]
              resources:
                requests:
                  storage: 100Gi
        additionalScrapeConfigs:
        - job_name: 'skysentinel-api'
          scrape_interval: 30s
          kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
              - skysentinel-production
          relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: api-gateway
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            action: keep
            regex: 8000
        
        - job_name: 'skysentinel-neo4j'
          scrape_interval: 30s
          static_configs:
          - targets:
            - neo4j-prometheus:2004
        
    grafana:
      adminPassword: ${GRAFANA_ADMIN_PASSWORD}
      persistence:
        enabled: true
        size: 10Gi
      dashboardProviders:
        dashboardproviders.yaml:
          apiVersion: 1
          providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards
      dashboards:
        default:
          skysentinel-dashboard:
            url: https://raw.githubusercontent.com/skysentinel/dashboards/main/grafana/dashboard.json
          kubernetes-dashboard:
            gnetId: 1621
            revision: 21
            datasource: Prometheus
    
    alertmanager:
      alertmanagerSpec:
        resources:
          requests:
            memory: 256Mi
            cpu: 100m
          limits:
            memory: 512Mi
            cpu: 200m
        config:
          global:
            slack_api_url: ${SLACK_WEBHOOK_URL}
          route:
            group_by: ['alertname']
            group_wait: 10s
            group_interval: 10s
            repeat_interval: 1h
            receiver: 'slack-notifications'
          receivers:
          - name: 'slack-notifications'
            slack_configs:
            - channel: '#skysentinel-alerts'
              send_resolved: true
              title: '{{ .GroupLabels.alertname }}'
              text: |-
                {{ range .Alerts }}
                  *Alert:* {{ .Annotations.summary }}
                  *Description:* {{ .Annotations.description }}
                  *Severity:* {{ .Labels.severity }}
                  *Instance:* {{ .Labels.instance }}
                  *Value:* {{ .Value }}
                {{ end }}
