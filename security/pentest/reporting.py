from typing import Dict, List, Any, Optional
from datetime import datetime
import json
from jinja2 import Template
import pdfkit
import csv
import io
import base64

class PentestReportGenerator:
    """Generate comprehensive penetration testing reports"""
    
    def __init__(self):
        self.html_template = self._load_html_template()
        self.pdf_template = self._load_pdf_template()
    
    def _load_html_template(self) -> Template:
        """Load HTML report template"""
        template_str = """
<!DOCTYPE html>
<html>
<head>
    <title>SkySentinel Penetration Test Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .header { background: #2c3e50; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .summary { background: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .test-section { background: white; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .test-header { background: #3498db; color: white; padding: 15px; border-radius: 5px 5px 0 0; }
        .test-content { padding: 15px; }
        .finding { margin-bottom: 10px; padding: 15px; border-left: 4px solid #ddd; }
        .critical { border-left-color: #dc3545; }
        .high { border-left-color: #f39c12; }
        .medium { border-left-color: #ffc107; }
        .low { border-left-color: #28a745; }
        .severity-critical { color: #dc3545; font-weight: bold; }
        .severity-high { color: #f39c12; font-weight: bold; }
        .severity-medium { color: #ffc107; font-weight: bold; }
        .severity-low { color: #28a745; font-weight: bold; }
        .risk-score { font-size: 24px; font-weight: bold; text-align: center; margin: 20px 0; }
        .risk-low { color: #28a745; }
        .risk-medium { color: #ffc107; }
        .risk-high { color: #f39c12; }
        .risk-critical { color: #dc3545; }
        .chart { margin: 20px 0; text-align: center; }
        .recommendation { background: #fff3cd; border: 1px solid #b8daff; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .footer { text-align: center; margin-top: 40px; color: #666; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; font-weight: bold; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #28a745, #20c997); transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="header">
        <h1>SkySentinel Penetration Test Report</h1>
        <p>Generated on {{ timestamp }}</p>
    </div>
    
    <div class="summary">
        <h2>Executive Summary</h2>
        <div class="risk-score risk-{{ risk_level }}">
            Risk Score: {{ risk_score }}/100
        </div>
        <p><strong>Target:</strong> {{ target }}</p>
        <p><strong>Duration:</strong> {{ duration }} seconds</p>
        <p><strong>Total Tests:</strong> {{ summary.total_tests }}</p>
        <p><strong>Tests Passed:</strong> {{ summary.tests_passed }}</p>
        <p><strong>Tests Failed:</strong> {{ summary.tests_failed }}</p>
        <p><strong>Total Findings:</strong> {{ summary.findings.CRITICAL + summary.findings.HIGH + summary.findings.MEDIUM + summary.findings.LOW }}</p>
        
        <h3>Findings by Severity</h3>
        <table>
            <tr>
                <th>Severity</th>
                <th>Count</th>
                <th>Percentage</th>
            </tr>
            <tr>
                <td class="severity-critical">Critical</td>
                <td>{{ summary.findings.CRITICAL }}</td>
                <td>{{ ((summary.findings.CRITICAL / total_findings) * 100)|round(1) }}%</td>
            </tr>
            <tr>
                <td class="severity-high">High</td>
                <td>{{ summary.findings.HIGH }}</td>
                <td>{{ ((summary.findings.HIGH / total_findings) * 100)|round(1) }}%</td>
            </tr>
            <tr>
                <td class="severity-medium">Medium</td>
                <td>{{ summary.findings.MEDIUM }}</td>
                <td>{{ ((summary.findings.MEDIUM / total_findings) * 100)|round(1) }}%</td>
            </tr>
            <tr>
                <td class="severity-low">Low</td>
                <td>{{ summary.findings.LOW }}</td>
                <td>{{ ((summary.findings.LOW / total_findings) * 100)|round(1) }}%</td>
            </tr>
        </table>
    </div>
    
    {% for test in tests %}
    <div class="test-section">
        <div class="test-header">
            <h3>{{ test.test }} ({{ test.category }})</h3>
            <span class="severity-{{ test.severity.lower() }}">{{ test.severity }}</span>
        </div>
        <div class="test-content">
            <p><strong>Timestamp:</strong> {{ test.timestamp }}</p>
            
            {% if test.findings %}
                <h4>Findings ({{ test.findings|length }})</h4>
                {% for finding in test.findings %}
                <div class="finding {{ finding.severity.lower() }}">
                    <h5 class="severity-{{ finding.severity.lower() }}">{{ finding.issue }}</h5>
                    <p><strong>Details:</strong> {{ finding.details }}</p>
                    <p><strong>Recommendation:</strong> {{ finding.recommendation }}</p>
                </div>
                {% endfor %}
            {% else %}
                <p><strong>No findings detected</strong></p>
            {% endif %}
        </div>
    </div>
    {% endfor %}
    
    <div class="summary">
        <h2>Recommendations</h2>
        {% for rec in recommendations %}
        <div class="recommendation">
            <h4>{{ rec.issue }} ({{ rec.severity }})</h4>
            <p><strong>Test:</strong> {{ rec.test }}</p>
            <p><strong>Category:</strong> {{ rec.category }}</p>
            <p><strong>Recommendation:</strong> {{ rec.recommendation }}</p>
        </div>
        {% endfor %}
    </div>
    
    <div class="footer">
        <p>Report generated by SkySentinel Penetration Testing Framework</p>
        <p>Confidential - Do not distribute</p>
    </div>
</body>
</html>
        """
        return Template(template_str)
    
    def _load_pdf_template(self) -> Template:
        """Load PDF report template"""
        template_str = """
<!DOCTYPE html>
<html>
<head>
    <title>{{ title }}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .section { margin-bottom: 30px; }
        .finding { margin-bottom: 15px; padding: 10px; border-left: 3px solid #ddd; }
        .critical { border-left-color: #d32f2f; }
        .high { border-left-color: #f44336; }
        .medium { border-left-color: #ff9800; }
        .low { border-left-color: #4caf50; }
    </style>
</head>
<body>
    <div class="header">
        <h1>{{ title }}</h1>
        <p>{{ date }}</p>
    </div>
    
    {% for section in sections %}
    <div class="section">
        <h2>{{ section.title }}</h2>
        {% for finding in section.findings %}
        <div class="finding {{ finding.severity.lower() }}">
            <h3>{{ finding.issue }}</h3>
            <p>{{ finding.details }}</p>
            <p><strong>Recommendation:</strong> {{ finding.recommendation }}</p>
        </div>
        {% endfor %}
    </div>
    {% endfor %}
</body>
</html>
        """
        return Template(template_str)
    
    def generate_html_report(self, results: Dict[str, Any]) -> str:
        """Generate HTML report"""
        total_findings = (
            results["summary"]["findings"]["CRITICAL"] +
            results["summary"]["findings"]["HIGH"] +
            results["summary"]["findings"]["MEDIUM"] +
            results["summary"]["findings"]["LOW"]
        )
        
        # Determine risk level
        if results["risk_score"] >= 80:
            risk_level = "critical"
        elif results["risk_score"] >= 60:
            risk_level = "high"
        elif results["risk_score"] >= 40:
            risk_level = "medium"
        else:
            risk_level = "low"
        
        return self.html_template.render(
            timestamp=results["timestamp"],
            target=results["target"],
            duration=results["duration"],
            summary=results["summary"],
            risk_score=results["risk_score"],
            risk_level=risk_level,
            total_findings=total_findings,
            tests=results["tests"],
            recommendations=results["recommendations"]
        )
    
    def generate_pdf_report(self, results: Dict[str, Any]) -> bytes:
        """Generate PDF report"""
        # Create HTML content
        html_content = self.generate_html_report(results)
        
        # Convert HTML to PDF
        pdf_bytes = pdfkit.from_string(html_content)
        return pdf_bytes
    
    def generate_json_report(self, results: Dict[str, Any]) -> str:
        """Generate JSON report"""
        return json.dumps(results, indent=2, default=str)
    
    def generate_csv_report(self, results: Dict[str, Any]) -> str:
        """Generate CSV report"""
        output = io.StringIO()
        writer = csv.writer(output)
        
        # Write header
        writer.writerow([
            "Test", "Category", "Severity", "Issue", "Details", "Recommendation", "Timestamp"
        ])
        
        # Write findings
        for test in results["tests"]:
            for finding in test.get("findings", []):
                writer.writerow([
                    test["test"],
                    test["category"],
                    finding["severity"],
                    finding["issue"],
                    finding["details"],
                    finding["recommendation"],
                    test["timestamp"]
                ])
        
        return output.getvalue()
    
    def generate_executive_summary(self, results: Dict[str, Any]) -> Dict[str, Any]:
        """Generate executive summary"""
        total_findings = (
            results["summary"]["findings"]["CRITICAL"] +
            results["summary"]["findings"]["HIGH"] +
            results["summary"]["findings"]["MEDIUM"] +
            results["summary"]["findings"]["LOW"]
        )
        
        # Determine risk level
        if results["risk_score"] >= 80:
            risk_level = "critical"
            risk_description = "Immediate action required"
        elif results["risk_score"] >= 60:
            risk_level = "high"
            risk_description = "High risk - address promptly"
        elif results["risk_score"] >= 40:
            risk_level = "medium"
            risk_description = "Medium risk - plan remediation"
        else:
            risk_level = "low"
            risk_description = "Low risk - monitor regularly"
        
        return {
            "target": results["target"],
            "risk_score": results["risk_score"],
            "risk_level": risk_level,
            "risk_description": risk_description,
            "total_tests": results["summary"]["total_tests"],
            "tests_passed": results["summary"]["tests_passed"],
            "tests_failed": results["summary"]["tests_failed"],
            "total_findings": total_findings,
            "critical_findings": results["summary"]["findings"]["CRITICAL"],
            "high_findings": results["summary"]["findings"]["HIGH"],
            "medium_findings": "results["summary"]["findings"]["MEDIUM"],
            "low_findings": results["summary"]["findings"]["LOW"],
            "compliance_rate": (results["summary"]["tests_passed"] / results["summary"]["total_tests"]) * 100 if results["summary"]["total_tests"] > 0 else 0,
            "timestamp": results["timestamp"],
            "duration": results["duration"]
        }
    
    def generate_trend_analysis(self, historical_results: List[Dict]) -> Dict[str, Any]:
        """Generate trend analysis from historical results"""
        if not historical_results:
            return {"error": "No historical data available"}
        
        # Sort by timestamp
        sorted_results = sorted(historical_results, key=lambda x: x.get("timestamp", ""))
        
        # Calculate trends
        risk_trend = []
        compliance_trend = []
        
        for result in sorted_results:
            risk_trend.append({
                "timestamp": result["timestamp"],
                "risk_score": result["risk_score"],
                "total_findings": sum(result["summary"]["findings"].values())
            })
            
            compliance_trend.append({
                "timestamp": result["timestamp"],
                "compliance_rate": (result["summary"]["tests_passed"] / result["summary"]["total_tests"]) * 100 if result["summary"]["total_tests"] > 0 else 0
            })
        
        return {
            "period": f"{sorted_results[0]['timestamp']} to {sorted_results[-1]['timestamp']}",
            "risk_trend": risk_trend,
            "compliance_trend": compliance_trend,
            "risk_improvement": risk_trend[-1]["risk_score"] - risk_trend[0]["risk_score"] if len(risk_trend) > 1 else 0,
            "compliance_improvement": compliance_trend[-1]["compliance_rate"] - compliance_trend[0]["compliance_rate"] if len(compliance_trend) > 1 else 0
        }
    
    def generate_remediation_plan(self, results: Dict[str, Any]) -> Dict[str, Any]:
        """Generate prioritized remediation plan"""
        recommendations = results["recommendations"]
        
        # Group by severity
        critical_issues = [r for r in recommendations if r["severity"] == "CRITICAL"]
        high_issues = [r for r in recommendations if r["severity"] == "HIGH"]
        medium_issues = [r for r in recommendations if r["severity"] == "MEDIUM"]
        low_issues = [r for r in recommendations if r["severity"] == "LOW"]
        
        return {
            "immediate_actions": critical_issues,
            "short_term": high_issues,
            "medium_term": medium_issues,
            "long_term": low_issues,
            "total_recommendations": len(recommendations),
            "priority_breakdown": {
                "critical": len(critical_issues),
                "high": len(high_issues),
                "medium": len(medium_issues),
                "low": len(low_issues)
            }
        }
    
    def export_report(self, results: Dict[str, Any], format: str = "html", output_path: str = None) -> str:
        """Export report to file"""
        if format == "html":
            content = self.generate_html_report(results)
            filename = "pentest_report.html"
        elif format == "pdf":
            content_bytes = self.generate_pdf_report(results)
            filename = "pentest_report.pdf"
            content = base64.b64encode(content_bytes).decode()
        elif format == "json":
            content = self.generate_json_report(results)
            filename = "pentest_report.json"
        elif format == "csv":
            content = self.generate_csv_report(results)
            filename = "pentest_report.csv"
        else:
            raise ValueError(f"Unsupported format: {format}")
        
        if output_path:
            filename = output_path
        
        with open(filename, "w") as f:
            f.write(content)
        
        return filename

class PentestAnalytics:
    """Analytics and metrics for penetration testing"""
    
    def __init__(self):
        self.test_history = []
        self.vulnerability_trends = {}
    
    def add_test_result(self, results: Dict[str, Any]):
        """Add test result to history"""
        self.test_history.append(results)
        self._update_vulnerability_trends(results)
    
    def _update_vulnerability_trends(self, results: Dict[str, Any]):
        """Update vulnerability tracking"""
        for test in results["tests"]:
            for finding in test.get("findings", []):
                issue = finding["issue"]
                severity = finding["severity"]
                
                if issue not in self.vulnerability_trends:
                    self.vulnerability_trends[issue] = {
                        "first_seen": results["timestamp"],
                        "last_seen": results["timestamp"],
                        "occurrences": 1,
                        "severity": severity
                    }
                else:
                    self.vulnerability_trends[issue]["last_seen"] = results["timestamp"]
                    self.vulnerability_trends[issue]["occurrences"] += 1
    
    def get_vulnerability_trends(self) -> Dict[str, Any]:
        """Get vulnerability trends"""
        return self.vulnerability_trends
    
    def get_most_common_vulnerabilities(self, limit: int = 10) -> List[Dict]:
        """Get most common vulnerabilities"""
        sorted_vulns = sorted(
            self.vulnerability_trends.items(),
            key=lambda x: x[1]["occurrences"],
            reverse=True
        )
        
        return [
            {
                "issue": issue,
                "occurrences": data["occurrences"],
                "severity": data["severity"],
                "first_seen": data["first_seen"],
                "last_seen": data["last_seen"]
            }
            for issue, data in sorted_vulns[:limit]
        ]
    
    def get_test_statistics(self) -> Dict[str, Any]:
        """Get test statistics"""
        if not self.test_history:
            return {"error": "No test data available"}
        
        total_tests = len(self.test_history)
        total_findings = sum(
            sum(test["summary"]["findings"].values())
            for test in self.test_history
        )
        
        avg_risk_score = sum(test["risk_score"] for test in self.test_history) / total_tests
        
        return {
            "total_tests": total_tests,
            "total_findings": total_findings,
            "average_risk_score": avg_risk_score,
            "test_history_size": len(self.test_history),
            "vulnerability_count": len(self.vulnerability_trends),
            "unique_vulnerabilities": len(self.vulnerability_trends)
        }
